services:
  qbittorrent:
    image: qbittorrentofficial/qbittorrent-nox:latest
    container_name: homeserver-qbittorrent
    restart: unless-stopped
    environment:
      - QBT_LEGAL_NOTICE=confirm
      - QBT_WEBUI_PORT=8081
    volumes:
      - ./data/qbittorrent/config:/config
      - ./data/downloads:/downloads
    network_mode: host

  qbittorrent-setup:
    image: alpine:latest
    container_name: homeserver-qbittorrent-setup
    depends_on:
      - qbittorrent
    volumes:
      - ./setup-qbittorrent.sh:/setup.sh:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    network_mode: host
    command: ["/bin/sh", "/setup.sh"]
    restart: "no"

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: homeserver-prowlarr
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Moscow
    volumes:
      - ./data/prowlarr/config:/config
    network_mode: host

  prowlarr-setup:
    image: alpine:latest
    container_name: homeserver-prowlarr-setup
    depends_on:
      - prowlarr
    volumes:
      - ./setup-prowlarr.sh:/setup.sh:ro
      - ./data/prowlarr/config:/config
    network_mode: host
    command: ["/bin/sh", "/setup.sh"]
    restart: "no"

  torrserver:
    image: ghcr.io/yourok/torrserver:latest
    container_name: homeserver-torrserver
    restart: unless-stopped
    ports:
      - "8091:8090"  # Changed to avoid conflict with existing TorrServer
    volumes:
      - ./data/torrserver:/opt/ts
    networks:
      - homeserver-network

  telegram-bot:
    build: .
    container_name: homeserver-telegram-bot
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - QBITTORRENT_URL=http://localhost:8081
      - PROWLARR_URL=http://localhost:9696
    env_file:
      - .env
    depends_on:
      - qbittorrent
      - qbittorrent-setup
      - prowlarr
      - prowlarr-setup
      - torrserver
    network_mode: host
    volumes:
      - ./logs:/app/logs

networks:
  homeserver-network:
    driver: bridge